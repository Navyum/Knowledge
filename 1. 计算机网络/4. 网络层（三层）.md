# 又叫IP层

# 主要解决问题：

1. 数据包的传输和路由选择功能
2. IP地址的分配和管理功能
# ICMP 协议（Internet Control Message Protocol）：

## 查询报文类型：

8: 主动查询

0: 主动查询回显

  

## 差错报文类型：

3：终点不可达

4：源抑制（让源站放慢发送速度）

5：重定向

11: 超时

# 具体应用：

**ping**：  主动发送查询报文，获得查询回显报文

**traceroute**:  发送udp数据包

            1. 探测沿途的路由（超时类型）: 使用特殊的TTL，将TTL逐个累增，逐个获取链路上的路由器 IP
            2. 探测目的主机（不可达类型）：使用不可能UDP端口号，收到端口不可达回应，则表示成功到达目的主机 
            3. 确定整条路径的MTU（分片错误类型）：故意设置为不分片，每次收到该差错报文，则调小MTU，知道到达目的主机
# 网关（gateway）：负责不同网络之间的通信，三层转发的设备

主机访问另一个IP的过程：

1. 判断是否同一个网段（基于**CIDR**和子网掩码）
2. 如果同网段，先封装目标IP头，再根据ARP协议获取目标IP的 MAC，封装MAC头，直接发送到目标机器
3. 非同网段，则先封装目标IP头，基于ARP获取网关MAC，再封装网关MAC，将数据先发给网关，网关收到包后，解开MAC头发现是自己的，再解开IP头，发现不是自己的，继续转发。转发规则如下。
# 网关转发规则：

1. 静态路由：
在网关上，配置一条一条规则，基于规则判断下一跳是哪里

2. 动态路由：
    1. 动态路由器根据路由协议算法生成动态路由表
    2. 距离矢量路由算法（基于 Bellman-Ford 算法）
        1. 具体实现：每个路由器都保存一个全局路由表
        2. 问题：更新时需要发送整个路由表信息，同步成本高；路由器故障，只能被动发现，更新不及时。
    3. 链路状态路由算法（基于 Dijkstra 算法）
        1. 具体实现：当自己链路状态发生变化，将自己和邻居之间的链路状态包广播给其他路由器，每个路由器在自己本地构建一个完整的图，然后针对这个图使用 Dijkstra 算法，找到两点之间的最短路径。
        2. 优点：只广播改变的链路状态，广播量小；任意路由出现故障，会引起相邻路由的多个广播，更新及时。
3. 动态路由协议：
    1. **OSPF**（Open Shortest Path First，开放式最短路径优先）
        1. 基于UDP同步路由信息
        2. 应用：广泛应用在**数据中心**（即内网）
        3. 所以又叫内部网关协议（Interior Gateway Protocol，简称 **IGP**）

    2. BGP（Border Gateway Protocol，外部网关协议）
        1. 基于TCP同步信息
        2. 应用：用于数据中心跟**外部其他边界路由器**之间的路由
        3. BGP 又分为两类，eBGP 和 iBGP。自治系统间，**边界路由器**之间使用 eBGP 广播路由。内部网络也需要访问其他的自治系统。边界路由器如何将 BGP 学习到的路由导入到内部网络呢？就是通过运行 iBGP，使得内部的路由器能够找到到达外网目的地的最好的边界路由器。
        4. 自制系统AS：
            1. Stub AS：对外只有一个连接。这类 AS 不会传输其他 AS 的包。例如，个人或者小公司的网络。
            2. Multihomed AS：可能有多个连接连到其他的 AS，但是大多拒绝帮其他的 AS 传输包。例如一些大公司的网络。
            3. Transit AS：有多个连接连到其他的 AS，并且可以帮助其他的 AS 传输包。例如主干网。
![图片](./IMG/4.%20网络层（三层）.md/68cf5604.png)




# 路由三要素：

1. 目的网络：这个包想去哪儿
2. 出口设备：将包从哪个口扔出去
3. 下一跳网关：下一个路由器（网关）的地址
# 路由表：多条规则的集合

# 网关类型：

1. 不改变 IP 地址的网关，即转发网关（两个ip在同一个局域网、不同的网段）
2. 改变 IP 地址的网关，即 **NAT** （Network Address Translation）网关  （两个ip在不同的局域网，需要将IP改为公网IP）



