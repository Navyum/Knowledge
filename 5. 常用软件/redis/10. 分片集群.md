## 分片集群方案：
1. 官方的 redis cluster
2. 更早更稳定的codis

### redis cluster实现：
1. 如何查找key对应value: key -> CRC16 + 和16384取模 -> local hash slot map -> 具体的redis实例-> 对应value
2. 使用哈希槽（Hash Slot）处理数据和实例之间的映射关系
3. 哈希槽信息如何获取和更新：Redis每个实例会把自己的哈希槽信息发给和它相连接的其它实例（广播），来完成哈希槽分配信息的扩散。当所有实例连接完成，每个实例都有所有哈希槽的映射关系。
4. 图解
    ![图片](./IMG/10.%20redis分片集群方案.md/3edcf054.png)
5. 特殊case：集群中Redis 实例的内存大小配置不一时，使用cluster addslots手动分配，但是在手动分配哈希槽时，需要把 16384 个槽都分配完，否则 Redis 集群无法正常工作。
6. 客户端如何通过key获取对应实例
    1. 客户端连接实例，实例把哈希槽的分配信息发给客户端
    2. 客户端请求键值对时，先计算键所对应的哈希槽，找到对应的实例
7. 集群扩容和数据迁移
    1. 因为hash的方式，扩容时会发生迁移
    2. 当哈希槽发生变化时，Redis Cluster 提供重定向机制，让客户端到新实例查询.
    3. 此时哈希槽对应的实例可能已经迁移完成或者正在迁移中
    4. 如果返回MOVED，表示已迁移完成，客户端更新哈希槽信息；如果返回ASK，则不更新。客户端需要向返回的实例发送ASKING之后，再发get查询。
```plain
    GET hello:key
    (error) MOVED 13320 172.16.19.5:6379   (已迁移)
    (error) ASK 13320 172.16.19.5:6379     (迁移中)
```

已完成：
![图片](./IMG/10.%20redis分片集群方案.md/4c1ec943.png)

迁移中：
![图片](./IMG/10.%20redis分片集群方案.md/637a4236.png)

### redis cluster特性：
1. Redis Cluster采用无中心化的模式（无proxy，客户端与服务端直连）
2. hash slot简化了节点扩容、缩容的难度，便于集群的维护和管理，但是增加了客户端映射表的维护成本，客户端需要支持重定向机制带来的新的协议。


### codis实现：
1. 如何查找key对应value: 使用1024个逻辑槽，给redis实例分配若干逻辑槽。key 通过CRC32 算法计算数据 key 的哈希值，和1024取模得到具体槽的编号 ，查找槽和实例路由表，到对应实例查询
2. 使用1024个逻辑槽，映射key和逻辑槽的关系
3. 逻辑槽信息如何获取和更新：在codis dashboard 上分配好路由表，dashboard 会把路由表push给 codis proxy，也会把路由表保存在 Zookeeper 中。codis-proxy 会把路由表缓存在本地，当它接收到客户端请求后查找本地缓存。当proxy宕机重启，则从zookeeper获取配置
4. 图解：
![图片](./IMG/10.%20redis分片集群方案.md/6b03c222.png)
5. 客户端如何通过key获取对应实例：
    a. 客户端直接和 codis proxy 建立连接,使用RESP协议交互
    b. codis proxy 接收到请求，查询key 和codis server 的映射关系
    c. proxy将请求转发给相应的 codis server 进行处理，并返回给客户端对应数据
6. 集群扩容和数据迁移：
    1. 因为hash的方式，扩容时会发生迁移
    2. 启动新的 codis server，将它加入集群
    3. 把部分数据迁移到新的 server
    4. Codis 集群按照 Slot 的粒度进行数据迁移
    5. Codis 从要迁移的 Slot 中随机选择一个数据，发送给目的 server
    6. server 正常响应，并将本地的key删除。如果是bigkey，则会拆分成多次，使用过期时间来保证数据一致性。bigkey迁移中断，则新 server会在过期后删除bigkey。
    7. 重复e和f
    8. 支持同步迁移和异步迁移两种方式。
        1. 同步指发送迁移数据到目的server时，阻塞当前slot等待ACK。优点：逻辑简单，不会出现数据不一致。缺点：会影响正常用户访问。
        2. 异步是指源server把数据发送给目的 server之后，继续处理用户请求。key被发送之后，会被设置为只读以确保数据一致性。Codis 在异步迁移 Slot 时，允许每次迁移多个 key。
7. codis可靠性集群设计：
![图片](./IMG/10.%20redis分片集群方案.md/0eb249a1.png)
    1. server使用主从模式进行读写分离，从库挂了不影响服务。
    2. 使用哨兵集群，实现主从自动切换，故障转移
    3. 使用zookeeper集群存储 slot-> redis实例路由表，确保proxy列表获取的可用性
    4. codis proxy设计为无状态服务，可以随时扩容

### 二者比较：
![图片](./IMG/10.%20redis分片集群方案.md/14864f2a.png)