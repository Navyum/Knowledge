### 解决什么问题：
主库挂了之后，实现主从库`自动切换`（故障转移）

### 哨兵机制：
1. 哨兵是一个运行在特殊模式下的 Redis 进程，每个哨兵都需要和所有的redis实例建立连接。
2. 负责 监控、选主和通知
![图片](./IMG/09.%20哨兵.md/38432c09.png)

### 哨兵集群：
1. 判定是否需要进行主、从切换标准：`达成客观下线`
    * 避免单个哨兵的误判，所以采用了集群方式
    * 主观下线：哨兵进程会使用 PING 命令发现主库或者从库超时，则将其主观下线
    * 客观下线：N 个哨兵实例，超过半数(N/2 + 1) 实例判断主库为“主观下线”，则判定主库为“客观下线”
    ![图片](./IMG/09.%20哨兵.md/a0f53725.png)

2. 如何选择新的主库：`筛选+打分`
![图片](./IMG/09.%20哨兵.md/57294ba4.png)
* 打分规则：
    1. 从库优先级越高，得分越高（slave-priority 配置项给实例单独配置）
    2. 从库复制进度越接近主库，得分高（slave_repl_offset 接近 master_repl_offset）
    3. 从库 ID 号越小，得分高

3. 哨兵之间如何`互相发现`：`基于主库的 pub/sub 机制`
* 哨兵在主库上进行发布（自己的信息）、订阅（其他哨兵信息）。
* 具体就是主库上有一个名为“__sentinel__:hello”的频道，不同哨兵就是通过它来相互发现，实现互相通信的。
![图片](./IMG/09.%20哨兵.md/b6de49f1.png)

4. 哨兵如何获取从库IP和PORT：
哨兵向主库发送 INFO 命令，主库接受到这个命令后，就会把从库列表返回给哨兵![图片](./IMG/09.%20哨兵.md/7fc6d993.png)

5. 哨兵如何与客户端建立连接:
哨兵实例`自身也提供 pub/sub 机制`，客户端可以从哨兵订阅消息。
哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件
![图片](./IMG/09.%20哨兵.md/9a3d9795.png)

6. 由哪个哨兵执行主从切换：`quorum 机制进行Leader选举`
在投票过程中，任何一个想成为 Leader 的哨兵，要满足两个条件：
    * 第一，拿到半数以上的赞成票；
    * 第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。

